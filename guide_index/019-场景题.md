# 场景题

## 如何实现百万数据的导入导出功能

1、明确技术栈为esay-excel

（1）速度快

（2）解决poi造成的内存溢出的问题

2、多线程处理sheet页

3、多线程处理数据

4、批量插入

5、换一种思路解决并发安全问题，每次处理数据都传入新的listener，从而减少并发安全类的使用

参考文章：https://juejin.cn/post/7287144182967353398#heading-45



## 如何实现一个抽奖系统

封装一个抽奖组件，内部使用lua脚本，在一个脚本中实现，库存的检查、扣减等动作。





## 你们是如何关闭到期的订单的，比如30分钟未支付，关单

我先说一下可能的几种方案，当然没有最好的方案，只有最适合的方案。

| 方案名称            | 实现原理                                             | 优点                                                         | 缺点                                                         |
| ------------------- | ---------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 定时任务            | 通过调度平台周期性扫描到期订单并执行关单操作         | 实现简单，易于上手；基于成熟的调度框架，可靠性较高           | 时间不精准，可能存在延迟；无法有效处理大订单量，对数据库造成较大压力 |
| 延迟消息队列        | 利用消息队列的延迟消息功能，在订单创建时发送延迟消息 | 解耦系统，提高可扩展性和可维护性；支持高并发处理，能够应对大订单量场景 | 需要引入额外的消息队列中间件，增加系统复杂性；延迟消息的精度可能受影响 |
| Redis过期监听       | 利用Redis的键过期通知功能执行关单操作                | Redis性能高，适用于实时性要求较高的场景；无需额外引入消息队列等中间件 | 过期通知并非实时触发，可能存在延迟；需要手动实现消息重试和兜底机制 |
| JDK自带的DelayQueue | 将订单包装为实现了Delayed接口的对象放入DelayQueue中  | 无需依赖外部资源，实现简单；JDK原生支持，稳定性高            | 适用于单机场景，分布式环境下需要额外处理数据一致性问题；内存限制 |
| 时间轮              | 使用时间轮数据结构，周期性执行到期任务               | 时间复杂度低，插入和删除操作效率高；适用于分布式场景         | 实现复杂，需要自行开发或引入第三方库；内存限制；机器重启会导致数据丢失 |

我在工作中，用得最多的是`延迟消息队列`这个方案，用得是MQ的消息队列，有时候还会配合定时任务扫表。





## 一个订单，在超时关闭的瞬间，客户支付了，并且支付成功了，这种情况你怎么处理

按道理有2种推进的方式：

1、让订单成功

2、让支付退款

我在xxxx工作时，也遇到过这种情况，当时的做法就是给客户退款了，并且会通知客服联系客户说明情况。那为什么要给客户退款呢？

一方面，订单的`已取消`状态一般是终态，终态是不能进行流转操作的。另一方面订单取消，一般不仅仅只是取消这么一个操作，万一还有其他操作呢？比如这笔订单，参与了营销活动，当订单取消的时候，券啊，积分啊啥的都已经退回去了，这个时候再手动加回来，处理难度是非常大的。当然用户是上帝，我也被要求让订单成功的情况，那种就是人工智能了。